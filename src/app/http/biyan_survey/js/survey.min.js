function rtrim(a){return a.replace(/(\s*$)/g,"")}function showimg(a){$(a).fadeToggle(400)}function scrollerInit(a){var b,c=$("#"+a).attr("data-content"),d=c.split(","),e=((new Date).getFullYear(),{});if(e["default"]={theme:"mobiscroll",display:"modal",mode:"scroller",lang:"zh"},b=d[0],"YYYYMMDD"==b){e.date={defaultValue:new Date(parseInt(d[4].substr(0,4)),parseInt(d[4].substr(4,2)),parseInt(d[4].substr(6))),maxDate:new Date(parseInt(d[2].substr(0,4)),parseInt(d[2].substr(4,2)),parseInt(d[2].substr(6))),minDate:new Date(parseInt(d[1].substr(0,4)),parseInt(d[1].substr(4,2)),parseInt(d[1].substr(6)))};var f=$.extend(e.date,e["default"]);$("#"+a).mobiscroll().date(f)}else if("HHMM"==b){e.time={timeFormat:"HH:ii",timeWheels:"HHii",defaultValue:new Date(1970,1,1,parseInt(d[4].substr(0,2)),parseInt(d[4].substr(3))),maxDate:new Date(1970,1,1,parseInt(d[2].substr(0,2)),parseInt(d[2].substr(3))),minDate:new Date(1970,1,1,parseInt(d[1].substr(0,2)),parseInt(d[1].substr(3))),headerText:!1};var g=$.extend(e.time,e["default"]);$("#"+a).mobiscroll().time(g)}else if("NN"==b){e.number={step:parseFloat(d[3].substr(2)),defaultValue:d[4],max:parseInt(d[2]),min:parseInt(d[1])};var h=$.extend(e.number,e["default"]);$("#"+a).mobiscroll().number(h)}}function getDate(a){var b=a.replace(/\d+(?=-[^-]+$)/,function(a){return parseInt(a,10)}).match(/\d+/g);return new Date(b[0],parseInt(b[1])-1,b[2])}function T2N(a){var b,c=a.indexOf(":");return b=60*parseInt(a.substr(0,c))*60*1e3+60*parseInt(a.substr(c+1))*1e3}function specialhint(){return"2c501eaa-d3b8-5fe4-b4d3-aa27817058b9"==survey_to_get?1:0}function delObjElement(a,b){for(var c in b)parseInt(c)>a&&delete b[c]}function jp_result(a){$("#QArea").hide(),$("#ph").hide(),ss=String(survey_to_get),window.localStorage.removeItem(ss+"last_tab"),data_to_send.answers=[];for(var b in answer)data_to_send.answers.push({qid:b,answer:answer[b],clicks:click_timestamp[b]});data_to_send.remarks=[];for(var c in remark)data_to_send.remarks.push({"for":c,remark:remark[c].join("|")});data_to_send.survey={},data_to_send.survey.name=survey_name,data_to_send.survey.id=survey_id,data_to_send.submit_time=Date.now(),$.ajax({async:!0,type:"POST",timeout:6e3,url:api_url+"/submit/survey?pid="+pid+"&sid="+survey_to_get,data:JSON.stringify(data_to_send),success:function(a){localStorage.setItem(ss+"data_to_send",JSON.stringify(data_to_send)),localStorage.setItem(ss+"badge3","1"),localStorage.setItem(ss+"badge4","1"),localStorage.setItem(ss+"surveyContent",JSON.stringify(surveyx)),localStorage.setItem(ss+"ori",a),localStorage.setItem(ss+"times","1"),window.location.replace(result_page)},error:function(a,b,c){alert("网络异常，请检查网络并重新提交"),$("canvas").remove(),$("#QArea").show(),$("#ph").show()}}),showloading()}function indexOfPgId(a){var b=1,c=!1;for(q in question_ids){if(pg_prefix+a==question_ids[q]){c=!0;break}b++}return c?b:-1}function pgIdOfIndex(a){var b=1,c=!1;for(q in question_ids){if(a===b){c=!0;break}b++}return c?q:null}function pghide(){for(pg in question_ids)$("#"+question_ids[pg]).hide()}function hidePgafterXid(a){for(var b in question_ids)parseInt(b.substr(1))>parseInt(a)&&($("#"+question_ids[b]).hide(),$("#pgtheEnd").hide(),$("#"+question_ids[b]+" .sinbtn_press").addClass("sinbtn_ori"),$("#"+question_ids[b]+" .sinbtn_ori").removeClass("sinbtn_press"),$("#"+question_ids[b]+" .mulbtn_press").addClass("mulbtn_ori"),$("#"+question_ids[b]+" .mulbtn_ori").removeClass("mulbtn_press"),$("#"+question_ids[b]+" .fa-check-square").removeClass("fa fa-check-square"),$("#"+question_ids[b]+" [data-check]").attr("data-check","0"),$("#mb"+b.substr(1)).html('<span class="fa fa-hand-o-right"></span>&nbsp;没有或不知道...'))}function hidePgById(a){for(q in question_ids)pg_prefix+a==question_ids[q]&&$("#"+question_ids[q]).hide()}function hidePgByIndex(a){$("#"+question_ids[pgIdOfIndex(a)]).hide()}function showPgById(a){var b,c;for(q in question_ids)if(pg_prefix+a==question_ids[q]){var d="#"+question_ids[q],e=$(d).attr("data-phase"),f=$(d).attr("data-alg"),g=$(d).attr("qid");if(1==specialhint()&&(40>a||"qid"==e.substr(0,3).toLowerCase()||(40==a&&(hid2=11),130==a&&(hid2=50),hid1++,$("#xh"+a).text(hid1+"/"+hid2),$("#sh"+a).show())),"0"==e){var h=$(d).height();$(d).show(),b=$(window).height()-h,h<$(window).height()?$("#ph").css("height",b+"px"):$("#ph").css("height","10px")}else{if("alg1"==e){var j,k,l,m,n=f.split(",");j=remark[parseInt(n[1])][0],k=remark[parseInt(n[2])][0],l=remark[parseInt(n[3])][0],m=j/(k-l+864e5),remark[g]=[],remark[g].push(m);var o=all_questions[indexOfPgId(a)-1].option_list.length;for(i=0;i<o;i++){var p=all_questions[indexOfPgId(a)-1].option_list[i].description,r=p.split(",");if(m<r[1]){answer[g]=[],answer[g].push(i),c=all_questions[indexOfPgId(a)-1].option_list[i].next_qid;break}}return void showPgById(c)}if("alg2"==e){var m,n=f.split(",");m=remark[parseInt(n[1])][0],remark[g]=[],remark[g].push(m);var o=all_questions[indexOfPgId(a)-1].option_list.length;for(i=0;i<o;i++){var p=all_questions[indexOfPgId(a)-1].option_list[i].description,r=p.split(",");if(m<r[1]){answer[g]=[],answer[g].push(i),c=all_questions[indexOfPgId(a)-1].option_list[i].next_qid;break}}return void showPgById(c)}if("System"==e){data_to_send.answers=[];for(var s in answer)data_to_send.answers.push({qid:s,answer:answer[s]});data_to_send.survey={},data_to_send.survey.name=survey_name,data_to_send.survey.id=survey_id;return void $.ajax({async:!0,type:"POST",url:api_url+"/calculate/survey?pid="+pid+"&sid="+survey_to_get,data:JSON.stringify(data_to_send),success:function(b){var d=parseInt(JSON.parse(b).type0);sss=parseInt(100*indexOfPgId(a)+d),c=parseInt($("#"+sss).attr("next-qid")),showPgById(c)},failure:function(a){alert("手机网络连接出现问题")}})}if("qid"==e.substr(0,3).toLowerCase())return qqq=parseInt(e.substr(3)),sss=parseInt(100*indexOfPgId(a)+answer[qqq][0]+1),c=parseInt($("#"+sss).attr("next-qid")),void showPgById(c)}}b>0?0==h&&"#pgtheEnd"==d?$("html, body, .content").animate({scrollTop:$(document).height()-$(window).height()-18-44-135},400):$("html, body, .content").animate({scrollTop:$(document).height()-$(window).height()-18-44},400):$("html, body, .content").animate({scrollTop:$(document).height()-h-33-44},400)}function showPgByIndex(a){$("#"+question_ids[pgIdOfIndex(a)]).show()}function jump_pg(a){var b=a.id,c=$(a).attr("qid"),d=indexOfPgId(c),e=$(a).attr("next-qid"),f=indexOfPgId(e),g=b%100-1;if("1"!=$(a).attr("data-submit")&&"2"!=$(a).attr("data-submit")&&"4"!=$(a).attr("data-submit")){var h=all_questions[d-1].option_list[g].explanation;if(void 0==h&&void 0!=all_questions[f-1]){var i,j=all_questions[f-1].strings;for(s in j)"header"===j[s].purpose&&(i=j[s].content);h=i}if(""!=h&&h){$("#header"+e).html(h),$("#header"+e).parent().css("white-space","pre-wrap");var k='<hr width="100%" class="hrcolor" size="1">';$("#hrr"+e).html(k)}else{$("#header"+e).html("");var l=$("#header"+e).parent().text();rtrim(l).length<16?$("#header"+e).parent().css("white-space","nowrap"):$("#header"+e).parent().css("white-space","pre-wrap"),$("#hrr"+e).html("")}}var m=c;if((""==answer[m]||void 0==answer[m])&&(answer[m]=[],click_timestamp[m]=[]),"1"==$(a).attr("data-submit"))"0"==$(a).attr("data-check")?($(a).attr("data-check","1"),answer[m].push(g),click_timestamp[m].push(Date.now()),$(a).removeClass("mulbtn_ori"),$(a).addClass("mulbtn_press"),$("#s"+b).addClass("fa fa-check-square"),$("#mb"+c).text("恩,选好了,go")):($(a).attr("data-check","0"),answer[m].splice(answer[m].indexOf(g),1),0==answer[m].length&&$("#mb"+c).html('<span class="fa fa-hand-o-right"></span>&nbsp;没有或不知道...'),click_timestamp[m].push(Date.now()),$(a).removeClass("mulbtn_press"),$(a).addClass("mulbtn_ori"),$("#s"+b).removeClass("fa fa-check-square"));else if("2"==$(a).attr("data-submit"))answer[m]==[]||void 0==answer[m]?alert("请至少选择一项噢！"):(hidePgafterXid(m),delObjElement(m,answer),delObjElement(m,click_timestamp),delObjElement(m,remark),showPgById(e));else if("4"==$(a).attr("data-submit")){var n=$(a).attr("data-id");if(""==$("#"+n).val()&&"text"!=$(a).attr("data-itype"))alert("亲，请先选择奥");else{remark[m]=[];var o=$(a).attr("data-content");"YY"==o.substr(0,2)?remark[m].push(Date.parse(getDate($("#"+n).val()))):"HH"==o.substr(0,2)?remark[m].push(T2N($("#"+n).val())):remark[m].push($("#"+n).val()),hidePgafterXid(m),delObjElement(m,answer),delObjElement(m,click_timestamp),delObjElement(m,remark),showPgById(e)}}else 0==answer[m].length?(answer[m].push(g),click_timestamp[m].push(Date.now()),$(a).removeClass("sinbtn_ori"),$(a).addClass("sinbtn_press"),showPgById(e)):($(a).removeClass("sinbtn_ori"),$(a).addClass("sinbtn_press"),$(a).siblings().removeClass("sinbtn_press"),$(a).siblings().addClass("sinbtn_ori"),answer[m]=[],answer[m].push(g),click_timestamp[m]=[],click_timestamp[m].push(Date.now()),hidePgafterXid(m),delObjElement(m,answer),delObjElement(m,click_timestamp),delObjElement(m,remark),showPgById(e))}function showloading(){var a=function(a,b,c){var d=this;this.c=a,this.ctx=a.getContext("2d"),this.cw=b,this.ch=c,this.loaded=0,this.loaderSpeed=.6,this.loaderHeight=10,this.loaderWidth=.8*this.cw/2,this.loader={x:this.cw/2-this.loaderWidth/2,y:this.ch/2-this.loaderHeight/2},this.particles=[],this.particleLift=180,this.hueStart=0,this.hueEnd=120,this.hue=0,this.gravity=.15,this.particleRate=4,this.init=function(){this.loop()},this.rand=function(a,b){return~~(Math.random()*(b-a+1)+a)},this.hitTest=function(a,b,c,d,e,f,g,h){return!(e>a+c||a>e+g||f>b+d||b>f+h)},this.updateLoader=function(){this.loaded<100?this.loaded+=this.loaderSpeed:this.loaded=0},this.renderLoader=function(){this.ctx.fillStyle="#000000";var a;a=window.innerWidth>window.innerHeight?window.innerWidth/40:window.innerWidth/20,window.devicePixelRatio&&(a*=window.devicePixelRatio);var b="正在按照多位专家的经验",c="分析您的症状";this.ctx.font="bold "+a+"px 微软雅黑",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(b,this.loader.x+this.loaderWidth/2,this.loader.y+this.loaderHeight+a),this.ctx.fillText(c,this.loader.x+this.loaderWidth/2,this.loader.y+this.loaderHeight+3*a),this.hue=this.hueStart+this.loaded/100*(this.hueEnd-this.hueStart);var d=this.loaded/100*this.loaderWidth;this.ctx.fillStyle="hsla("+this.hue+", 100%, 40%, 1)",this.ctx.fillRect(this.loader.x,this.loader.y,d,this.loaderHeight),this.ctx.fillStyle="#222",this.ctx.fillRect(this.loader.x,this.loader.y,d,this.loaderHeight/2)},this.Particle=function(){this.x=d.loader.x+d.loaded/100*d.loaderWidth-d.rand(0,1),this.y=d.ch/2+d.rand(0,d.loaderHeight)-d.loaderHeight/2,this.vx=(d.rand(0,4)-2)/100,this.vy=(d.rand(0,d.particleLift)-2*d.particleLift)/100,this.width=d.rand(1,4)/2,this.height=d.rand(1,4)/2,this.hue=d.hue},this.Particle.prototype.update=function(a){this.vx+=(d.rand(0,6)-3)/100,this.vy+=d.gravity,this.x+=this.vx,this.y+=this.vy,this.y>d.ch&&d.particles.splice(a,1)},this.Particle.prototype.render=function(){d.ctx.fillStyle="hsla("+this.hue+", 100%, "+d.rand(50,70)+"%, "+d.rand(20,100)/100+")",d.ctx.fillRect(this.x,this.y,this.width,this.height)},this.createParticles=function(){for(var a=this.particleRate;a--;)this.particles.push(new this.Particle)},this.updateParticles=function(){for(var a=this.particles.length;a--;){var b=this.particles[a];b.update(a)}},this.renderParticles=function(){for(var a=this.particles.length;a--;){var b=this.particles[a];b.render()}},this.clearCanvas=function(){this.ctx.globalCompositeOperation="source-over",this.ctx.clearRect(0,0,this.cw,this.ch),this.ctx.globalCompositeOperation="lighter"},this.loop=function(){var a=function(){requestAnimationFrame(a,d.c),d.clearCanvas(),d.createParticles(),d.updateLoader(),d.updateParticles(),d.renderLoader(),d.renderParticles()};a()}},b=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))},c=function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a));return vid=window.setTimeout(function(){b(d+e)},e),a=d+e,vid}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})};if(b){var d=document.createElement("canvas");d.width=window.innerWidth;var e=d.getContext("2d"),f=e.canvas.width,g=e.canvas.height;e.canvas.style.backgroundColor="#ffffff",window.devicePixelRatio&&(e.canvas.style.width=f+"px",e.canvas.style.height=g+"px",e.canvas.height=g*window.devicePixelRatio,e.canvas.width=f*window.devicePixelRatio);var h=e.canvas.width,i=e.canvas.height;document.body.appendChild(d);var j=new a(d,h,i);c(),j.init()}}function start(a){survey_to_get=a.survey_to_get,result_page=a.result_page,pid=a.partner_id,data_to_send.start_time=Date.now(),data_to_send.user_id=a.openid,data_to_send.partner_openid=a.partner_openid,data_to_send.coordinates=a.coordinates,$("#loading").hide(),$.get(api_url+"/get/survey?sid="+survey_to_get+"&pid="+pid).done(function(b){surveyx=b,survey_id=b._id,survey_name=b.name,survey_desc=b.description,all_questions=b.questions;var c=all_questions.length,d=0;for(d=1;c>=d;d++){var e,f,g=all_questions[d-1],h=g.qid,i=g.strings,j=0;for(var k in i)"footer"===i[k].purpose&&(f=i[k].content),"header"===i[k].purpose&&(e=i[k].content,j=e.length);var l,m=g.body;Math.max(m.length,j)>.6*window.innerWidth/14-2?l='style="word-break: break-all"':(l='style="white-space:nowrap"',m+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");for(var n=g.option_list,o=g.allow_multi_choice||!1,p=g.decided_by||"0",r="alg"==g.body.substr(0,3)?g.body:"0",s=n.length,t=g.next_qid||(d==c?theEnd:all_questions[d].qid),u="",v=" qid="+h+(o?' data-submit="1" data-check="0" ':" "),w=1;s>=w;w++){var x,y=" id="+(100*d+w)+" ",z=100*d+w,A=n[w-1],B=A.description,C=(A.expect_input||!1,A.input_type||!1),D=A.next_qid||t,E=o?"":" next-qid="+D+" ";x=B.length>.52*window.innerWidth*4/14?'style="padding-top:10px;line-height:1.5;height:125px;text-align:left"':B.length>.52*window.innerWidth*3/14?'style="padding-top:10px;line-height:1.5;height:100px;text-align:left"':B.length>.52*window.innerWidth*2/14?'style="padding-top:10px;line-height:1.5;height:75px;text-align:left"':B.length>.52*window.innerWidth/14?'style="padding-top:10px;line-height:1.5;height:50px;text-align:left"':'style="word-break:keep-all;overflow:hidden"',C?("text"==C?u+="<textarea "+y+' placeholder="'+B+'" data-submit="3" data-type="'+C+'" class="button button-circle button-flat-textinput"/>':"scroller"==C&&(u+="<input "+y+' type="text" placeholder="亲，请选择" data-submit="3" data-type="'+C+'" data-content="'+B+'"class="button button-circle button-flat-whiteinput"/>',sArrary.push(100*d+w)),u+='<a href="#" id="ib'+h+'" qid='+h+' next-qid="'+D+'" data-id="'+(100*d+w)+'" data-content="'+B+'" data-itype="'+C+'" data-submit="4" onclick="jump_pg(this);return false"class="button button-circle button-flat-black"><span class="fa fa-hand-o-right"></span>&nbsp;确定...</a>'):u+=o?"<a "+y+' href="#" '+v+E+'onclick="jump_pg(this);return false"data-check="0" class="button button-circle button-flat-white mulbtn_ori"'+x+'><span id="s'+z+'">&nbsp;&nbsp;</span>'+B+"</a>":"<a "+y+' href="#" '+v+E+'onclick="jump_pg(this);return false"data-check="0" class="button button-circle button-flat-white sinbtn_ori" '+x+">"+B+"</a>"}o&&(u+='<a href="#" id="mb'+h+'" qid='+h+' next-qid="'+D+'" data-id="mb'+h+'" data-submit="2" onclick="jump_pg(this);return false"class="button button-circle button-flat-black"><span class="fa fa-hand-o-right"></span>&nbsp;没有或不知道...</a>'),question_ids["q"+h]=pg_prefix+h,e?question_page_html["q"+h]='<div id="'+question_ids["q"+h]+'" qid="'+h+'" data-alg="'+r+'" data-phase="'+p+'"><div class="shintmain" id="sh'+h+'"><div class="shint" id="xh'+h+'">'+d+"/"+c+'</div></div><div class="leftd'+String(a.css_style)+'"><div class="speech left"'+l+'><span class="sheader" id="header'+h+'">'+e+'</span><div class="hrcolor" id="hrr"'+h+'><hr width="100%" size="1"></div><div data-id="'+d+'">'+m+'</div></div></div><div class="rightd'+String(a.css_style)+'"><div class="speech right" ><div id="'+pg_prefix+d+'-content"><div class="btg'+d+'0">'+u+"</div></div></div></div></div>":question_page_html["q"+h]='<div id="'+question_ids["q"+h]+'" qid="'+h+'" data-alg="'+r+'" data-phase="'+p+'"><div class="shintmain" id="sh'+h+'"><div class="shint" id="xh'+h+'">'+d+"/"+c+'</div></div><div class="leftd'+String(a.css_style)+'"><div class="speech left"'+l+'><span class="sheader" id="header'+h+'"></span><div id="hrr'+h+'"></div><div data-id="'+d+'">'+m+'</div></div></div><div class="rightd'+String(a.css_style)+'"><div class="speech right" ><div id="'+pg_prefix+d+'-content"><div class="btg'+d+'0">'+u+"</div></div></div></div></div>"}last_page=d,question_ids["q"+theEnd]=pg_prefix+theEnd;var F=question_ids["q"+theEnd],G="您的评估报告我已经写好啦！",H="请点击查看",I="jp_result(this)";"9456282f-6c2b-f47f-fb47-2b1295e284a4"==survey_to_get&&(G="感谢您的参与！",H="提交");var J='<div id="pgtheEnd" data-phase="0"><div class="leftd'+String(a.css_style)+'" id="'+F+'_left"><div class="speech left"><div><span class="lasttext">'+G+'</span><div class="hrcolor"><hr width="100%" size="1"></div><a href="#" id="b'+F+'" onclick="'+I+'" class="button button-circle button-flat-primary">'+H+"</a></div></div></div></div>",K="";for(q in question_page_html)K+=question_page_html[q];if($("#QArea").html(K+J),1==specialhint()&&$(".shintmain").hide(),sArrary.length>0)for(d=0;d<sArrary.length;d++)scrollerInit(sArrary[d]);pghide(),showPgByIndex(1)})}var survey_to_get=0,result_page="",user_id=null,coordinates=[0,0],api_url="https://www.ihaola.com.cn/api",survey_id,answer={},remark={},click_timestamp={},surveyx={},survey_name="",survey_desc="",all_questions=[],result={},pg_prefix="pg",theEnd="theEnd",question_page_html={},question_ids={},pid="",ss,sss,qqq,hid1=0,hid2=0,data_to_send={},sArrary=[],vid;